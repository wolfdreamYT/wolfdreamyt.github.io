<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebBot v3.0</title>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.0.0/fetch.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/core-js-bundle/minified.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/2.6.12/core.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/regenerator-runtime/0.13.9/runtime.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 18px; background:#0f1113; color:#e6eef0; }
    textarea { width:100%; height:120px; font-family:monospace; background:#0b0b0b; color:#bfe; padding:10px; border-radius:8px; border:1px solid #222; }
    input[type=number]{ padding:8px; border-radius:6px; width:160px; }
    button{ padding:10px 14px; border-radius:8px; background:#197278; color:#fff; border:none; cursor:pointer; margin-right:8px; }
    pre{ background:#000; color:#8cff8c; padding:12px; border-radius:8px; height:420px; overflow:auto; white-space:pre-wrap; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans p-6">

    <div class="max-w-3xl mx-auto space-y-6">
      <h1 class="text-3xl font-bold text-teal-400">WebBot v3.0</h1>

      <div>
        <label class="block font-semibold mb-2">URLs (one per line):</label>
        <textarea id="seeds" class="w-full h-32 bg-gray-800 border border-gray-700 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-teal-500">https://example.com</textarea>
      </div>

      <div class="flex flex-wrap items-center gap-4">
        <div>
          <label class="block font-semibold mb-1">Max pages:</label>
          <input id="max_pages" type="number" min="1" max="300" value="5"
                class="w-32 bg-gray-800 border border-gray-700 rounded-lg p-2 focus:ring-2 focus:ring-teal-500" />
        </div>
        <div class="flex-1"></div> 
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="saveBtn" class="bg-teal-600 hover:bg-teal-700 px-5 py-2 rounded-lg font-semibold">Save URLs</button>
        <button id="runBtn" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-lg font-semibold">Run scan & download</button>
      </div>

      <div>
        <h2 class="text-xl font-bold mt-4 mb-2">Output</h2>
        <pre id="output" class="bg-black text-green-300 p-4 rounded-lg h-72 overflow-auto text-sm whitespace-pre-wrap">
  Currently on standby mode.
        </pre>
      </div>
    </div>

    <script>
        // ---- CONFIG ----
        const POLL_INTERVAL = 1000; // check every 1 seconds
        const RESOURCE_URL = window.location.href; 

        // ---- FUNCTION ----
        async function checkServer() {
        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 1500);

            const response = await fetch(RESOURCE_URL, { cache: 'no-store', signal: controller.signal });
            clearTimeout(timeout);

            if (!response.ok) throw new Error('Non-OK response'); 
        } catch (err) {
            console.warn('Server unreachable, refreshing page...');
            location.reload(); 
        }
        }

        // ---- START POLLING ----
        setInterval(checkServer, POLL_INTERVAL);
    </script>

  <script>
    const out = document.getElementById("output");
    document.getElementById("saveBtn").onclick = async () => {
      const res = await fetch("/save", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          seeds: document.getElementById("seeds").value,
          max_pages: document.getElementById("max_pages").value
        })
      });
      const j = await res.json();
      out.textContent = j.ok ? "Saved seeds and max_pages." : ("Error: "+(j.error||"unknown"));
    };

    document.getElementById("runBtn").onclick = async () => {
      out.innerHTML = "Starting WebBot...\n\n";
      try {
        const resp = await fetch("/run", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ max_pages: document.getElementById("max_pages").value })
        });
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        let zipTriggered = false;

        while (!done) {
          const {value, done: streamDone} = await reader.read();
          if (value) {
            const chunk = decoder.decode(value);
            out.innerHTML += chunk;
            out.scrollTop = out.scrollHeight;

            // check for sentinel <!--DONE-->zipname
            const m = chunk.match(/<!--DONE-->([^\s<]+)/);
            if (m && !zipTriggered) {
              zipTriggered = true;
              const zipname = m[1];
              if (zipname === "NO_OUTPUT") {
                out.innerHTML += "\nNo output folder found to zip.\n";
              } else if (zipname.startsWith("ERROR_ZIP_CREATION")) {
                out.innerHTML += "\nError creating zip: " + zipname + "\n";
              } else {
                out.innerHTML += `\nPreparing download: ${zipname}\n`;
                const dlUrl = `/download/${zipname}`;
                const a = document.createElement('a');
                a.href = dlUrl;
                a.download = zipname;
                document.body.appendChild(a);
                a.click();
                a.remove();
                out.innerHTML += `\nDownload triggered: ${zipname}\n`;
              }
            }
          }
          done = streamDone;
        }
        out.innerHTML += "\nProcess finished.\n";
      } catch (err) {
        out.innerHTML += "\nError running scan: " + err + "\n";
      }
    };
  </script>
</body>
</html>
